{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <h2 class="text-center mb-4">Kidney Disease Risk Prediction</h2>
        
        <div class="card shadow-lg border-0">
            <div class="card-body">
                <form id="kidneyForm" class="needs-validation" novalidate>
                    <!-- Sample Data Buttons -->
                    <div class="card mb-4 border-primary">
                        <div class="card-body">
                            <h5 class="card-title">Sample Data</h5>
                            <p class="text-muted small mb-3">Load predefined sample values to test the prediction model</p>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-success" id="loadLowRiskKidney">
                                    <i class="fas fa-check-circle"></i> Load Low Risk Sample
                                </button>
                                <button type="button" class="btn btn-danger" id="loadHighRiskKidney">
                                    <i class="fas fa-exclamation-triangle"></i> Load High Risk Sample
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="container-fluid">
                        <div class="row g-4">

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="age" class="form-label">Age</label>
                                    <div class="text-center mb-1"><span id="ageValue">50</span> years</div>
                                    <input type="range" class="form-range" id="age" name="age" min="1" max="100" value="50" required>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="bp" class="form-label">Blood Pressure (mm Hg)</label>
                                    <div class="text-center mb-1"><span id="bpValue">120</span> mm Hg</div>
                                    <input type="range" class="form-range" id="bp" name="bp" min="50" max="200" value="120" required>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="sg" class="form-label">Specific Gravity</label>
                                    <div class="text-center mb-1"><span id="sgValue">1.015</span></div>
                                    <input type="range" step="0.001" class="form-range" id="sg" name="sg" min="1.005" max="1.025" value="1.015" required>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="al" class="form-label">Albumin (g/dL)</label>
                                    <div class="text-center mb-1"><span id="alValue">0</span> g/dL</div>
                                    <input type="range" class="form-range" id="al" name="al" min="0" max="5" value="0" required>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="su" class="form-label">Sugar (g/dL)</label>
                                    <div class="text-center mb-1"><span id="suValue">0</span> g/dL</div>
                                    <input type="range" class="form-range" id="su" name="su" min="0" max="5" value="0" required>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="rbc" class="form-label">Red Blood Cells</label>
                                    <select class="form-select" id="rbc" name="rbc" required>
                                        <option value="">Select</option>
                                        <option value="0">Normal</option>
                                        <option value="1">Abnormal</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="pc" class="form-label">Pus Cell</label>
                                    <select class="form-select" id="pc" name="pc" required>
                                        <option value="">Select</option>
                                        <option value="0">Normal</option>
                                        <option value="1">Abnormal</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="pcc" class="form-label">Pus Cell Clumps</label>
                                    <select class="form-select" id="pcc" name="pcc" required>
                                        <option value="">Select</option>
                                        <option value="0">Not Present</option>
                                        <option value="1">Present</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="ba" class="form-label">Bacteria</label>
                                    <select class="form-select" id="ba" name="ba" required>
                                        <option value="">Select</option>
                                        <option value="0">Not Present</option>
                                        <option value="1">Present</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="bgr" class="form-label">Blood Glucose Random (mg/dL)</label>
                                    <div class="text-center mb-1"><span id="bgrValue">120</span> mg/dL</div>
                                    <input type="range" class="form-range" id="bgr" name="bgr" min="50" max="500" value="120" required>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="bu" class="form-label">Blood Urea (mg/dL)</label>
                                    <div class="text-center mb-1"><span id="buValue">40</span> mg/dL</div>
                                    <input type="range" class="form-range" id="bu" name="bu" min="10" max="200" value="40" required>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="sc" class="form-label">Serum Creatinine (mg/dL)</label>
                                    <div class="text-center mb-1"><span id="scValue">1.2</span> mg/dL</div>
                                    <input type="range" step="0.1" class="form-range" id="sc" name="sc" min="0.5" max="20" value="1.2" required>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="sod" class="form-label">Sodium (mEq/L)</label>
                                    <div class="text-center mb-1"><span id="sodValue">140</span> mEq/L</div>
                                    <input type="range" class="form-range" id="sod" name="sod" min="120" max="160" value="140" required>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="pot" class="form-label">Potassium (mEq/L)</label>
                                    <div class="text-center mb-1"><span id="potValue">4.5</span> mEq/L</div>
                                    <input type="range" step="0.1" class="form-range" id="pot" name="pot" min="2" max="8" value="4.5" required>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="hemo" class="form-label">Hemoglobin (g/dL)</label>
                                    <div class="text-center mb-1"><span id="hemoValue">15</span> g/dL</div>
                                    <input type="range" step="0.1" class="form-range" id="hemo" name="hemo" min="3" max="18" value="15" required>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="pcv" class="form-label">Packed Cell Volume</label>
                                    <div class="text-center mb-1"><span id="pcvValue">45</span></div>
                                    <input type="range" class="form-range" id="pcv" name="pcv" min="10" max="60" value="45" required>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="wc" class="form-label">White Blood Cell Count</label>
                                    <div class="text-center mb-1"><span id="wcValue">8000</span> cells/cumm</div>
                                    <input type="range" step="100" class="form-range" id="wc" name="wc" min="2000" max="20000" value="8000" required>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="rc" class="form-label">Red Blood Cell Count</label>
                                    <div class="text-center mb-1"><span id="rcValue">4.5</span> millions/cumm</div>
                                    <input type="range" step="0.01" class="form-range" id="rc" name="rc" min="2" max="7" value="4.5" required>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="htn" class="form-label">Hypertension</label>
                                    <select class="form-select" id="htn" name="htn" required>
                                        <option value="">Select</option>
                                        <option value="0">No</option>
                                        <option value="1">Yes</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="dm" class="form-label">Diabetes Mellitus</label>
                                    <select class="form-select" id="dm" name="dm" required>
                                        <option value="">Select</option>
                                        <option value="0">No</option>
                                        <option value="1">Yes</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="cad" class="form-label">Coronary Artery Disease</label>
                                    <select class="form-select" id="cad" name="cad" required>
                                        <option value="">Select</option>
                                        <option value="0">No</option>
                                        <option value="1">Yes</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="appet" class="form-label">Appetite</label>
                                    <select class="form-select" id="appet" name="appet" required>
                                        <option value="">Select</option>
                                        <option value="0">Good</option>
                                        <option value="1">Poor</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="pe" class="form-label">Pedal Edema</label>
                                    <select class="form-select" id="pe" name="pe" required>
                                        <option value="">Select</option>
                                        <option value="0">No</option>
                                        <option value="1">Yes</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card h-100 p-3 border-0 bg-light">
                                    <label for="ane" class="form-label">Anemia</label>
                                    <select class="form-select" id="ane" name="ane" required>
                                        <option value="">Select</option>
                                        <option value="0">No</option>
                                        <option value="1">Yes</option>
                                    </select>
                                </div>
                            </div>

                        </div> </div> <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">Predict Risk</button>
                    </div>
                </form>

                <div id="results" class="mt-4" style="display: none;">
                    <div class="alert" role="alert">
                        <h4 class="alert-heading">Prediction Results</h4>
                        <p id="predictionResult"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    
    // --- Dynamic Range Slider Value Display ---

    // 1. Set initial values on page load
    // Loop through all range inputs and set their display text
    $('input[type="range"]').each(function() {
        // Find the corresponding span (e.g., 'age' input finds 'ageValue' span)
        $('#' + this.id + 'Value').text(this.value);
    });

    // 2. Update values live as the slider is moved
    // Listen for the 'input' event on all range sliders
    $('input[type="range"]').on('input', function() {
        // Update the text of the corresponding span with the new value
        $('#' + this.id + 'Value').text(this.value);
    });

    // --- Sample Data Loaders ---
    
    // Low Risk Sample (Normal values - based on actual healthy ranges from training data)
    // Healthy ranges: bp: 60-80, sg: 1.02, age: 12-80, bu: 10-50, sc: 0.4-1.2, etc.
    $('#loadLowRiskKidney').on('click', function() {
        const lowRiskValues = [40, 70, 1.02, 0, 0, 0, 0, 0, 0, 100, 30, 0.9, 140, 4.3, 15, 46, 7000, 5.4, 0, 0, 0, 0, 0, 0];
        loadKidneyValues(lowRiskValues);
    });
    
    // High Risk Sample (Abnormal values)
    $('#loadHighRiskKidney').on('click', function() {
        const highRiskValues = [65, 180, 1.010, 3, 2, 1, 1, 1, 1, 250, 100, 3.5, 130, 5.5, 10, 30, 12000, 3.0, 1, 1, 1, 1, 1, 1];
        loadKidneyValues(highRiskValues);
    });
    
    // Function to load kidney values
    function loadKidneyValues(values) {
        const fieldOrder = [
            'age', 'bp', 'sg', 'al', 'su', 'rbc', 'pc', 'pcc', 'ba', 
            'bgr', 'bu', 'sc', 'sod', 'pot', 'hemo', 'pcv', 'wc', 'rc',
            'htn', 'dm', 'cad', 'appet', 'pe', 'ane'
        ];
        
        fieldOrder.forEach((fieldId, index) => {
            const value = values[index];
            const $field = $('#' + fieldId);
            
            if ($field.length) {
                if ($field.is('input[type="range"]')) {
                    $field.val(value);
                    $('#' + fieldId + 'Value').text(value);
                } else if ($field.is('select')) {
                    $field.val(value.toString());
                }
            }
        });
    }
    
    // --- Form Submission Handler ---
    
    // Intercept the 'submit' event of the form with id 'kidneyForm'
    $('#kidneyForm').on('submit', function(e) {
        // Prevent the default form submission (which would reload the page)
        e.preventDefault();

        // Send an AJAX request to the server
        $.ajax({
            url: '/predict_kidney', // The server endpoint for kidney prediction
            method: 'POST',
            data: $(this).serialize(), // Serialize all form data
            
            // On success, handle the JSON response
            success: function(response) {
                if (response.success) {
                    $('#results').show(); // Show the results box
                    // Set alert color: red for disease (1), green for no disease (0)
                    const resultClass = response.prediction === 1 ? 'alert-danger' : 'alert-success';
                    $('#results .alert').removeClass('alert-danger alert-success').addClass(resultClass);
                    // Set the prediction message
                    $('#predictionResult').text(response.message);
                } else {
                    alert('Error: ' + response.error);
                }
            },
            
            // On failure, show a generic error
            error: function() {
                alert('An error occurred while processing your request.');
            }
        });
    });
});
</script>
{% endblock %}